<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>সপ্তম শ্রেণি: আইসিটি ক্লাস টেস্ট</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        @keyframes background-pan {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        body {
            font-family: 'Hind Siliguri', sans-serif;
            background: linear-gradient(120deg, #0a0f1e, #101935, #0a0f1e);
            background-size: 200% 200%;
            color: #e0e7ff;
            line-height: 1.8;
            animation: background-pan 15s ease infinite;
        }
        .card {
            background: rgba(12, 20, 39, 0.6);
            border-radius: 1rem;
            padding: 2rem;
            border: 1px solid rgba(0, 210, 255, 0.2);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .action-button {
            background: linear-gradient(90deg, #00d2ff 0%, #3a7bd5 100%);
            color: white; padding: 0.8rem 1.5rem; border-radius: 0.5rem;
            font-weight: 600; transition: all 0.3s ease; cursor: pointer;
            width: 100%; border: none;
            box-shadow: 0 4px 15px rgba(0, 210, 255, 0.2);
        }
        .action-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 210, 255, 0.4);
        }
        .action-button:disabled { background: #555; cursor: not-allowed; box-shadow: none; }
        .hidden { display: none; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex; justify-content: center; align-items: center; z-index: 2000;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: rgba(12, 20, 39, 0.9);
            padding: 2rem; border-radius: 1rem; text-align: center;
            border: 1px solid rgba(239, 68, 68, 0.5);
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.4);
            max-width: 400px; width: 90%; color: #e0e7ff;
        }
        #progress-bar {
            height: 12px; background: linear-gradient(90deg, #3a7bd5 0%, #00d2ff 100%);
            border-radius: 9999px; transition: width 0.1s linear, background-color 0.5s ease;
        }
        .option-button {
            background: rgba(255, 255, 255, 0.05); color: #e0e7ff;
            padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 500;
            transition: all 0.3s ease; width: 100%; text-align: left;
            margin-bottom: 0.75rem; border: 1px solid rgba(0, 255, 255, 0.3);
        }
        .option-button:hover:not(.selected):not(.disabled) {
            background-color: rgba(0, 255, 255, 0.15); border-color: rgba(0, 255, 255, 0.7);
            transform: translateY(-2px); box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
        }
        .option-button.correct {
            background-color: #10B981 !important; color: white !important;
            border-color: #10B981 !important;
        }
        .option-button.incorrect {
            background-color: #EF4444 !important; color: white !important;
            border-color: #EF4444 !important;
        }
        .option-button.disabled { cursor: not-allowed; opacity: 0.7; }
    </style>
</head>
<body class="antialiased">
    <div class="container max-w-4xl mx-auto p-4 md:p-8">
        <header class="text-center mb-12">
            <img src="https://i.postimg.cc/J4SJrFNp/school-logo-1.png" alt="স্কুলের লোগো" class="mx-auto mb-6 w-32 h-32">
            <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-400 py-2">আইসিটি ক্লাস টেস্ট</h1>
            <p class="text-2xl mt-2 text-cyan-300">সপ্তম শ্রেণি</p>
        </header>

        <div id="login-container" class="max-w-xl mx-auto space-y-8">
            <div class="card">
                <h2 class="text-xl font-bold text-cyan-400 mb-4">নির্দেশনা</h2>
                <ul class="list-disc list-inside space-y-2 text-blue-200">
                    <li>একজন শিক্ষার্থী শুধুমাত্র **একবারই** এই পরীক্ষায় অংশ নিতে পারবে।</li>
                    <li>পরীক্ষা চলাকালীন অন্য ট্যাব খুললে পরীক্ষাটি **বাতিল হয়ে যাবে**।</li>
                    <li>প্রতিটি প্রশ্নের জন্য ৩৫ সেকেন্ড সময় পাবে।</li>
                </ul>
            </div>
            <div class="card">
                <h2 class="text-xl font-bold text-cyan-400 mb-4">লগইন করে শুরু করো</h2>
                <div>
                    <input type="number" id="student-roll" class="w-full text-center p-3 border border-cyan-400/30 bg-white/5 rounded-lg mb-4 focus:ring-2 focus:ring-cyan-400 focus:outline-none" placeholder="তোমার রোল নম্বর লেখো" required>
                    <input type="password" id="pin-input" class="w-full text-center p-3 border border-cyan-400/30 bg-white/5 rounded-lg mb-4 focus:ring-2 focus:ring-cyan-400 focus:outline-none" placeholder="তোমার গোপন পিন লেখো" required>
                    <button id="login-button" class="action-button">প্রবেশ করো</button>
                    <p id="error-message" class="text-red-400 mt-4 hidden text-center"></p>
                </div>
            </div>
        </div>

        <div id="quiz-section" class="card hidden">
            <div class="flex justify-between items-center mb-4">
                <p class="text-lg font-semibold">স্কোর: <span id="current-score">0</span></p>
                <p class="text-lg font-semibold text-cyan-400">প্রশ্ন <span id="question-number">1</span> / <span id="total-questions">0</span></p>
                <span id="timer" class="font-bold text-lg text-red-400"></span>
            </div>
            <div class="w-full bg-white/10 rounded-full mb-4">
                <div id="progress-bar"></div>
            </div>
            <h2 id="question-text" class="text-2xl font-bold mb-6 text-blue-300">প্রশ্ন লোড হচ্ছে...</h2>
            <div id="options-container" class="grid grid-cols-1 gap-3"></div>
            <p id="feedback" class="text-center font-bold mt-4 hidden"></p>
        </div>

        <div id="result-section" class="card hidden text-center">
            <h2 class="text-3xl font-bold mb-6 text-cyan-400">ক্লাস টেস্ট শেষ!</h2>
            <p><strong>নাম:</strong> <span id="participant-name"></span> | <strong>রোল:</strong> <span id="participant-roll"></span></p>
            <p class="text-2xl font-bold my-4 text-blue-300">তোমার ফাইনাল স্কোর: <span id="final-score">0</span> / <span id="final-total">0</span></p>
            <p id="submission-status" class="font-bold"></p>
            <button id="toggle-review-button" class="action-button mt-4">উত্তরগুলো দেখো</button>
        </div>

        <div id="answer-review-section" class="hidden mt-8 text-left">
            <h3 class="text-2xl font-bold text-center mb-4 text-cyan-400">প্রশ্নগুলোর বিস্তারিত ব্যাখ্যা</h3>
            <div id="review-container"></div>
        </div>
    </div>
    
    <div id="tab-switch-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>সতর্কতা!</h3>
            <p>তুমি ক্লাস টেস্ট চলাকালীন অন্য ট্যাবে চলে গিয়েছিলে। তোমার পরীক্ষাটি বাতিল করা হয়েছে।</p>
        </div>
    </div>

    <footer class="text-center mt-16 pt-8 border-t border-cyan-400/10">
        <p class="text-blue-200">ওমর কিন্ডারগার্টেন স্কুল এন্ড ওমর গার্টেন একাডেমি, জয়পুরহাট।</p>
        <p class="text-sm text-blue-400 mt-2">সর্বস্বত্ব সংরক্ষিত © ২০২৫ | Fahad Bin Mamun</p>
    </footer>

    <script>
        // --- Configuration ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzmiSke925eOsG22nKaJYufRoN8xUBIxHAoh9Ot83c_mcpSxS4yu6hwPvXvfBIxVOpK/exec';
        const QUESTIONS_PER_QUIZ = 20;
        const TIME_PER_QUESTION = 35; // সেকেন্ড
        const FEEDBACK_DELAY_MS = 1500;

        // --- DOM ELEMENTS ---
        const loginContainer = document.getElementById('login-container');
        const studentRollInput = document.getElementById('student-roll');
        const pinInput = document.getElementById('pin-input');
        const loginButton = document.getElementById('login-button');
        const errorMessage = document.getElementById('error-message');
        const quizSection = document.getElementById('quiz-section');
        const questionNumberSpan = document.getElementById('question-number');
        const totalQuestionsSpan = document.getElementById('total-questions');
        const questionTextElement = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const currentScoreSpan = document.getElementById('current-score');
        const feedbackElement = document.getElementById('feedback');
        const resultSection = document.getElementById('result-section');
        const participantNameSpan = document.getElementById('participant-name');
        const participantRollSpan = document.getElementById('participant-roll');
        const finalScoreSpan = document.getElementById('final-score');
        const finalTotalSpan = document.getElementById('final-total');
        const submissionStatus = document.getElementById('submission-status');
        const toggleReviewButton = document.getElementById('toggle-review-button');
        const answerReviewSection = document.getElementById('answer-review-section');
        const reviewContainer = document.getElementById('review-container');
        const tabSwitchModal = document.getElementById('tab-switch-modal');
        const timerSpan = document.getElementById('timer');
        const progressBar = document.getElementById('progress-bar');

        // --- STATE VARIABLES ---
        let studentInfo = {};
        let quizStarted = false;
        let timerInterval;
        let submittedAnswers = [];
        let allQuestions = []; // প্রশ্নগুলো এখানে লোড হবে
        let currentQuizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let isSubmitting = false; 
        let answerLocked = false;

        // --- FUNCTIONS ---
        function handleLogin() {
            const roll = studentRollInput.value.trim();
            const pin = pinInput.value.trim();

            if (!roll || !pin) {
                showError("রোল এবং পিন নম্বর দিন।");
                return;
            }
            
            loginButton.disabled = true;
            loginButton.textContent = "যাচাই করা হচ্ছে...";
            errorMessage.classList.add('hidden');
            
            const loginData = { action: 'verifyLogin', roll: roll, pin: pin };

            fetch(SCRIPT_URL, { 
                method: 'POST', 
                body: JSON.stringify(loginData),
                headers: { 'Content-Type': 'application/json' },
                mode: 'no-cors' // Use 'no-cors' to avoid CORS preflight issues with Apps Script redirects
            })
            .then(response => {
                // Since 'no-cors' gives an opaque response, we can't read the JSON directly.
                // We will rely on google.script.run for getting detailed success/error messages.
                // For now, we assume the request was sent and proceed to get questions.
                // A better approach would be to have the server-side script handle this, but this is a workaround.
                 loginButton.textContent = "প্রশ্ন লোড করা হচ্ছে...";
                 google.script.run
                    .withSuccessHandler(onLoginSuccess)
                    .withFailureHandler(onLoginFailure)
                    .verifyLogin(loginData);
            })
            .catch(err => {
                showError("সার্ভারের সাথে সংযোগে সমস্যা হয়েছে।");
                loginButton.disabled = false;
                loginButton.textContent = "প্রবেশ করো";
            });
        }
        
        function onLoginSuccess(data) {
            const response = JSON.parse(data); // Apps Script returns a stringified JSON
            if (response.result === 'success') {
                studentInfo = { name: response.name, roll: studentRollInput.value.trim() };
                getQuestionsFromServer();
            } else {
                onLoginFailure({ message: response.message });
            }
        }

        function onLoginFailure(error) {
            showError(error.message || "লগইন করা যায়নি।");
            loginButton.disabled = false;
            loginButton.textContent = "প্রবেশ করো";
        }

        function getQuestionsFromServer() {
            loginButton.textContent = "প্রশ্ন প্রস্তুত করা হচ্ছে...";
            google.script.run
                .withSuccessHandler(onQuestionsReceived)
                .withFailureHandler(onQuestionsFailed)
                .getQuestions();
        }

        function onQuestionsReceived(response) {
            if (response.result === 'success' && response.questions.length > 0) {
                allQuestions = response.questions;
                startQuiz();
            } else {
                showError(response.message || "প্রশ্ন লোড করা যায়নি বা কোনো প্রশ্ন নেই।");
                loginButton.disabled = false;
                loginButton.textContent = "প্রবেশ করো";
            }
        }

        function onQuestionsFailed(error) {
            showError("প্রশ্ন লোড করতে সমস্যা হয়েছে: " + error.message);
            loginButton.disabled = false;
            loginButton.textContent = "প্রবেশ করো";
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function startQuiz() {
            loginContainer.classList.add('hidden');
            quizSection.classList.remove('hidden');
            quizStarted = true;

            currentQuizQuestions = allQuestions.sort(() => 0.5 - Math.random()).slice(0, Math.min(QUESTIONS_PER_QUIZ, allQuestions.length));
            totalQuestionsSpan.textContent = currentQuizQuestions.length;
            
            loadQuestion();
        }

        function startTimer() {
            clearInterval(timerInterval);
            let timeLeft = TIME_PER_QUESTION;
            timerSpan.textContent = timeLeft;
            progressBar.style.width = '100%';
            progressBar.style.backgroundColor = '#00d2ff';

            timerInterval = setInterval(() => {
                timeLeft--;
                timerSpan.textContent = timeLeft;
                const percentage = (timeLeft / TIME_PER_QUESTION) * 100;
                progressBar.style.width = `${percentage}%`;

                if (percentage < 50) progressBar.style.backgroundColor = '#f59e0b';
                if (percentage < 25) progressBar.style.backgroundColor = '#ef4444';

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handleAnswer(null, "No Answer (Time Out)");
                }
            }, 1000);
        }

        function loadQuestion() {
            if (currentQuestionIndex >= currentQuizQuestions.length) {
                showResult();
                return;
            }

            answerLocked = false;
            const questionData = currentQuizQuestions[currentQuestionIndex];
            questionNumberSpan.textContent = currentQuestionIndex + 1;
            questionTextElement.textContent = questionData.question;
            optionsContainer.innerHTML = '';
            feedbackElement.classList.add('hidden');

            const shuffledOptions = [...questionData.options].sort(() => 0.5 - Math.random());

            shuffledOptions.forEach(optionText => {
                const button = document.createElement('button');
                button.classList.add('option-button');
                button.textContent = optionText;
                button.addEventListener('click', () => handleAnswer(button, optionText));
                optionsContainer.appendChild(button);
            });
            startTimer();
        }

        function handleAnswer(button, selectedOptionText) {
            if (answerLocked) return;
            answerLocked = true;

            clearInterval(timerInterval);
            const questionData = currentQuizQuestions[currentQuestionIndex];
            const correctOptionText = questionData.answer;
            
            document.querySelectorAll('#options-container .option-button').forEach(btn => {
                btn.classList.add('disabled');
                if (btn.textContent === correctOptionText) {
                    btn.classList.add('correct');
                }
            });

            submittedAnswers.push({
                question: questionData.question,
                userAnswer: selectedOptionText,
                correctAnswer: correctOptionText,
                explanation: questionData.explanation
            });

            if (selectedOptionText === correctOptionText) {
                score++;
                currentScoreSpan.textContent = score;
                if(button) button.classList.add('correct');
                feedbackElement.textContent = "সঠিক উত্তর!";
                feedbackElement.style.color = '#10B981';
            } else {
                if(button) button.classList.add('incorrect');
                feedbackElement.textContent = `ভুল। সঠিক উত্তর: ${correctOptionText}`;
                feedbackElement.style.color = '#EF4444';
            }
            feedbackElement.classList.remove('hidden');

            setTimeout(() => {
                currentQuestionIndex++;
                loadQuestion();
            }, FEEDBACK_DELAY_MS);
        }

        function showResult() {
            quizStarted = false;
            quizSection.classList.add('hidden');
            resultSection.classList.remove('hidden');

            participantNameSpan.textContent = studentInfo.name;
            participantRollSpan.textContent = studentInfo.roll;
            finalScoreSpan.textContent = score;
            finalTotalSpan.textContent = currentQuizQuestions.length;
            
            displayAnswerReview();
            sendDataToGoogleSheet();
        }

        function displayAnswerReview() {
            reviewContainer.innerHTML = ''; 
            submittedAnswers.forEach((result, index) => {
                const isCorrect = result.userAnswer === result.correctAnswer;
                const reviewBlock = document.createElement('div');
                reviewBlock.className = 'card mb-4 p-4 border-l-4 ' + (isCorrect ? 'border-green-500' : 'border-red-500');
                reviewBlock.innerHTML = `
                    <p class="font-bold text-lg">${index + 1}. ${result.question}</p>
                    <p class="mt-2 ${isCorrect ? 'text-green-400' : 'text-red-400'}">
                        <strong>তোমার উত্তর:</strong> ${result.userAnswer || 'N/A'} ${isCorrect ? '✔' : '❌'}
                    </p>
                    ${!isCorrect ? `<p class="mt-1 text-green-400"><strong>সঠিক উত্তর:</strong> ${result.correctAnswer}</p>` : ''}
                    <p class="mt-2 text-gray-400"><strong>ব্যাখ্যা:</strong> ${result.explanation || 'N/A'}</p>
                `;
                reviewContainer.appendChild(reviewBlock);
            });
        }

        function sendDataToGoogleSheet() {
            if (isSubmitting) return;
            isSubmitting = true; 
            submissionStatus.textContent = 'ফলাফল জমা দেওয়া হচ্ছে...';
            submissionStatus.style.color = 'orange';
            
            const resultData = {
                action: 'submitResult',
                studentName: studentInfo.name,
                studentRoll: studentInfo.roll,
                totalScore: `${score} / ${currentQuizQuestions.length}`,
                quizResultsJSON: JSON.stringify(submittedAnswers)
            };
            
            google.script.run
                .withSuccessHandler(onSubmitSuccess)
                .withFailureHandler(onSubmitFailure)
                .submitResult(resultData);
        }
        
        function onSubmitSuccess(response) {
            const data = JSON.parse(response);
            if (data.result === 'success') {
                submissionStatus.textContent = 'তোমার ফলাফল সফলভাবে জমা হয়েছে।';
                submissionStatus.style.color = '#10B981';
            } else {
                onSubmitFailure({message: data.message});
            }
             isSubmitting = false;
        }

        function onSubmitFailure(error) {
            submissionStatus.textContent = 'দুঃখিত, ফলাফল জমা দেওয়া যায়নি। সমস্যা: ' + (error.message || 'Unknown error');
            submissionStatus.style.color = '#EF4444';
            isSubmitting = false;
        }

        // --- EVENT LISTENERS ---
        loginButton.addEventListener('click', handleLogin);
        toggleReviewButton.addEventListener('click', () => {
            answerReviewSection.classList.toggle('hidden');
        });
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && quizStarted) {
                quizStarted = false;
                clearInterval(timerInterval);
                quizSection.classList.add('hidden');
                tabSwitchModal.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
